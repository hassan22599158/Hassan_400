<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>مشغل فيديو + ملخص ذكي + ملاحظات وصور + ترتيب يدوي</title>
  <style>
    /* --- الأنماط CSS --- */
     body {
      text-align: right;
      font-family: 'Arial', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f9f9f9;
      margin: 0;
      padding: 20px;
      transition: background-color 0.3s, color 0.3s;
    }
    #videoContainer, #summaryBox, #transcriptInput, .search-box, .notes-section, .lecture-images-section {
      width: 90%;
      max-width: 900px;
      margin: 15px auto;
      text-align: right;
      font-size: 16px;
      line-height: 1.8;
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0px 2px 5px rgba(0,0,0,0.2);
    }
    /* Styles for the new contenteditable div to look like a textarea */
    .editable-textarea-lookalike {
        width: 100%;
        height: 150px; /* Or min-height if you want it to grow */
        font-size: 16px;
        padding: 12px;
        margin-top: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        transition: background-color 0.3s, color 0.3s;
        font-family: 'Arial', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        text-align: right;
        direction: rtl;
        box-sizing: border-box;
        white-space: pre-wrap;
        word-wrap: break-word;
        overflow-y: auto; /* Add scroll if content exceeds height */
        background-color: #fff; /* Background for light mode */
        color: #333; /* Text color for light mode */
    }
    .dark-mode .editable-textarea-lookalike {
        background-color: #2d2d2d;
        color: #e0e0e0;
        border: 1px solid #444;
    }
    .editable-textarea-lookalike:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    }
    .dark-mode .editable-textarea-lookalike:focus {
        border-color: #4dabf7;
        box-shadow: 0 0 0 0.2rem rgba(77,171,247,.25);
    }
    /* Placeholder simulation for contenteditable div */
    .editable-textarea-lookalike:empty::before {
        content: attr(placeholder);
        color: #999;
        pointer-events: none;
        display: block; /* For the placeholder to show */
    }
    .dark-mode .editable-textarea-lookalike:empty::before {
        color: #777;
    }

    /* Style for the new main highlight palette */
    #mainHighlightPalette {
        display: flex;
        gap: 8px;
        margin-top: 10px;
        margin-bottom: 10px; /* Space before the action buttons */
        justify-content: flex-start; /* Align to the start (right in RTL) */
        padding: 5px;
        border: 1px solid #eee;
        border-radius: 4px;
        background-color: #f9f9f9;
    }
    .dark-mode #mainHighlightPalette {
        border-color: #333;
        background-color: #2d2d2d;
    }
    #mainHighlightPalette button {
        padding: 6px 10px;
        font-size: 13px;
        border: 1px solid #ccc;
        background-color: #fff;
        cursor: pointer;
        border-radius: 3px;
        line-height: 1.2;
    }
    .dark-mode #mainHighlightPalette button {
        border-color: #555;
        background-color: #444;
        color: #eee;
    }
    /* Specific colors for main palette buttons */
    #mainHighlightPalette button.main-color-pink { background-color: #FFBABA; color: #333; }
    #mainHighlightPalette button.main-color-yellow { background-color: #FFFF99; color: #333; }
    #mainHighlightPalette button.main-color-green { background-color: #CCFFCC; color: #333; }
    #mainHighlightPalette button.main-color-blue { background-color: #CCEEFF; color: #333; }
    #mainHighlightPalette button.main-color-orange { background-color: #FFDAB9; color: #333; }

    .dark-mode #mainHighlightPalette button.main-color-pink { background-color: #774141; color: #fff; border-color: #916262;}
    .dark-mode #mainHighlightPalette button.main-color-yellow { background-color: #757533; color: #fff; border-color: #919157;}
    .dark-mode #mainHighlightPalette button.main-color-green { background-color: #336633; color: #fff; border-color: #578057;}
    .dark-mode #mainHighlightPalette button.main-color-blue { background-color: #335577; color: #fff; border-color: #577391;}
    .dark-mode #mainHighlightPalette button.main-color-orange { background-color: #775733; color: #fff; border-color: #917a57;}


    input[type="text"] {
      width: 70%;
      padding: 12px;
      margin: 8px 0;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
      font-family: 'Arial', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      text-align: right;
      direction: rtl;
      box-sizing: border-box;
    }
    .control-btn, .record-btn {
      padding: 10px 15px;
      font-size: 15px;
      cursor: pointer;
      border: none;
      border-radius: 5px;
      background-color: #007bff;
      color: white;
      transition: 0.3s;
      box-shadow: 0px 2px 5px rgba(0,0,0,0.2);
      font-family: 'Arial', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      vertical-align: middle;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      text-decoration: none;
    }
    .control-btn:hover, .record-btn:hover {
      background-color: #0056b3;
    }
    .record-btn.recording {
      background-color: #dc3545;
    }
    .record-btn.recording:hover {
      background-color: #c82333;
    }
    iframe {
      width: 100%;
      height: 450px;
      border-radius: 8px;
      border: none;
    }
    .floating-controls {
      position: fixed;
      bottom: 25px;
      left: 25px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      z-index: 1000;
    }
    .floating-right-controls {
      position: fixed;
      bottom: 25px;
      right: 25px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      z-index: 1000;
    }
    #notesList {
      list-style-type: none;
      padding: 0;
      width: 90%;
      max-width: 900px;
      margin: 20px auto;
    }
    #notesList li {
      background-color: #fff;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 5px;
      box-shadow: 0px 1px 3px rgba(0,0,0,0.1);
      text-align: right;
      font-size: 15px;
      line-height: 1.6;
      overflow-wrap: break-word;
      word-wrap: break-word;
      position: relative;
      display: flex;
      align-items: flex-start;
      user-select: none;
      flex-direction: column;
    }
    #notesList li audio {
        width: 100%;
        max-width: 300px;
        margin-top: 10px;
        vertical-align: middle;
        margin-left: 10px; /* RTL */
    }
    .audio-annotation-text {
        font-size: 0.9em;
        color: #555;
        margin-top: 8px;
        padding: 8px;
        border-radius: 4px;
        background-color: #f0f0f0;
        border: 1px solid #e0e0e0;
        width: calc(100% - 16px);
        box-sizing: border-box;
        white-space: pre-wrap;
        word-wrap: break-word;
    }
    .dark-mode .audio-annotation-text {
        color: #ccc;
        background-color: #2a2a2a;
        border-color: #3a3a3a;
    }
    .text-note-content-editable {
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        padding: 10px;
        margin-top: 8px;
        border-radius: 4px;
        white-space: pre-wrap;
        word-wrap: break-word;
        width: 100%;
        box-sizing: border-box;
        min-height: 50px;
    }
    .dark-mode .text-note-content-editable {
        background-color: #2c2c2c;
        border-color: #3a3a3a;
        color: #e0e0e0;
    }
    .text-note-content-editable[contenteditable="true"] {
        border: 1px dashed #007bff !important;
        outline: none;
    }
    .dark-mode .text-note-content-editable[contenteditable="true"] {
        border: 1px dashed #4dabf7 !important;
    }
    .text-note-actions {
        margin-top: 10px;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
    }
    .highlight-palette { /* For in-list note editing */
        display: flex;
        gap: 5px;
        align-items: center;
        padding: 5px;
        border: 1px solid #eee;
        border-radius: 4px;
        background-color: #f9f9f9;
    }
    .dark-mode .highlight-palette {
        border-color: #333;
        background-color: #2d2d2d;
    }
    .highlight-palette button {
        padding: 5px 8px;
        font-size: 12px;
        min-width: auto;
        border: 1px solid #ccc;
        background-color: #fff;
        cursor: pointer;
        border-radius: 3px;
        line-height: 1.2;
    }
    .dark-mode .highlight-palette button {
        border-color: #555;
        background-color: #444;
        color: #eee;
    }
    .highlight-palette button.color-yellow { background-color: #FFFF99; color: #333; }
    .highlight-palette button.color-lightgreen { background-color: #CCFFCC; color: #333; }
    .highlight-palette button.color-lightblue { background-color: #CCEEFF; color: #333; }
    .highlight-palette button.color-lightpink { background-color: #FFDDDD; color: #333; }

    .dark-mode .highlight-palette button.color-yellow { background-color: #757533; color: #fff; border-color: #919157;}
    .dark-mode .highlight-palette button.color-lightgreen { background-color: #336633; color: #fff; border-color: #578057;}
    .dark-mode .highlight-palette button.color-lightblue { background-color: #335577; color: #fff; border-color: #577391;}
    .dark-mode .highlight-palette button.color-lightpink { background-color: #774444; color: #fff; border-color: #916262;}

    .speed-controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
    }
    .speed-btn {
      min-width: 65px;
      padding: 12px;
    }
    .clear-search-btn {
      padding: 10px 15px;
      font-size: 15px;
      cursor: pointer;
      border: none;
      border-radius: 5px;
      background-color: #dc3545;
      color: white;
      transition: 0.3s;
      box-shadow: 0px 2px 5px rgba(0,0,0,0.2);
      font-family: 'Arial', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      vertical-align: middle;
    }
    .clear-search-btn:hover {
      background-color: #c82333;
    }
     #notesList .control-btn, #notesList .clear-search-btn,
     #notesList .text-note-actions .control-btn,
     #notesList .text-note-actions .clear-search-btn {
        padding: 3px 8px;
        font-size: 13px;
        vertical-align: middle;
        margin-top: 0px;
     }
      #notesList .note-options-btn {
        padding: 3px 6px !important;
        font-size: 16px !important;
        vertical-align: middle;
        background-color: transparent !important;
        color: #6c757d !important;
        border: 1px solid #ced4da !important;
      }
      .dark-mode #notesList .note-options-btn {
          color: #adb5bd !important;
          border: 1px solid #495057 !important;
      }
      #notesList .note-options-btn:hover {
        background-color: rgba(0,0,0,0.05) !important;
      }
      .dark-mode #notesList .note-options-btn:hover {
        background-color: rgba(255,255,255,0.1) !important;
      }

     #notesList li b {
        font-weight: bold;
        color: #007bff;
        margin-left: 5px;
        display: inline;
     }
     .note-content {
         flex-grow: 1;
         width: 100%;
     }
     .reorder-buttons {
         display: flex;
         flex-direction: column;
         margin-left: auto;
         gap: 2px;
     }
     .reorder-buttons button {
         padding: 2px 5px;
         font-size: 10px;
         cursor: pointer;
         background-color: #6c757d;
         color: white;
         border: none;
         border-radius: 3px;
         transition: 0.3s;
     }
     .reorder-buttons button:hover {
         background-color: #5a6268;
     }
     .note-buttons-container {
         display: flex;
         justify-content: flex-end;
         align-items: center;
         flex-wrap: wrap;
         gap: 5px;
         margin-top: 8px;
         padding-right: 10px;
     }

    /* Dark Mode Styles */
    .dark-mode {
      background-color: #121212;
      color: #e0e0e0;
    }
    .dark-mode #videoContainer,
    .dark-mode #summaryBox,
    .dark-mode #transcriptInput,
    .dark-mode .search-box,
    .dark-mode .notes-section,
    .dark-mode .lecture-images-section {
      background-color: #1e1e1e;
      color: #e0e0e0;
      border: 1px solid #333;
    }
    /* .dark-mode textarea : Handled by .editable-textarea-lookalike */
    .dark-mode input[type="text"] {
      background-color: #2d2d2d;
      color: #e0e0e0;
      border: 1px solid #444;
    }
    .dark-mode .control-btn, .dark-mode .record-btn {
      background-color: #444;
      color: #fff;
    }
    .dark-mode .control-btn:hover, .dark-mode .record-btn:hover {
      background-color: #555;
    }
    .dark-mode .record-btn.recording {
        background-color: #a71d2a;
    }
    .dark-mode .record-btn.recording:hover {
        background-color: #8c1a24;
    }
    .dark-mode #notesList li {
      background-color: #2d2d2d;
      color: #e0e0e0;
      border: 1px solid #444;
    }
     .dark-mode #notesList li b {
        color: #4dabf7;
     }
    .dark-mode .clear-search-btn {
      background-color: #a71d2a;
    }
    .dark-mode .clear-search-btn:hover {
      background-color: #8c1a24;
    }
     .dark-mode #notesList li audio {
         filter: invert(1) hue-rotate(180deg);
     }
     .dark-mode .reorder-buttons button {
         background-color: #555;
     }
      .dark-mode .reorder-buttons button:hover {
          background-color: #777;
      }

    /* Highlight Styles */
    .highlight {
      background-color: yellow;
      color: black;
      padding: 0 3px;
      border-radius: 3px;
    }
    .custom-highlight { }

    .highlight-line {
      background-color: rgba(255, 255, 0, 0.3);
      border-left: 4px solid yellow;
      padding: 10px;
      margin: 10px 0;
      cursor: pointer;
      border-radius: 0 6px 6px 0;
      position: relative;
    }
     .highlight-line .control-btn {
        padding: 2px 6px !important;
        font-size: 12px !important;
        float: left;
        margin-right: 5px;
        position: absolute;
        right: 5px;
        top: 50%;
        transform: translateY(-50%);
     }
    .highlight-line:hover {
      background-color: rgba(255, 255, 0, 0.5);
    }
    .dark-mode .highlight-line {
        background-color: rgba(255, 255, 0, 0.2);
        border-left-color: #ffd700;
    }
    .dark-mode .highlight-line:hover {
        background-color: rgba(255, 255, 0, 0.3);
    }

    /* Summary Box Styles */
    #summaryBox {
      text-align: right;
      white-space: pre-wrap;
      word-wrap: break-word;
      font-family: 'Arial', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.8;
      padding: 20px;
      overflow-wrap: break-word;
      min-height: 100px;
    }
    #summaryBox b { font-weight: bold; color: #007bff; }
    .dark-mode #summaryBox b { color: #4dabf7; }
    #summaryBox i { font-style: italic; }
    #summaryBox u { text-decoration: underline; }
    #summaryBox h2, #summaryBox h3, #summaryBox h4 {
        margin-top: 1.5em; margin-bottom: 0.5em; color: #0056b3;
        border-bottom: 1px solid #eee; padding-bottom: 0.3em;
    }
    .dark-mode #summaryBox h2, .dark-mode #summaryBox h3, .dark-mode #summaryBox h4 {
        color: #66d9e8; border-bottom-color: #444;
    }
    #summaryBox ul, #summaryBox ol { padding-right: 20px; margin-bottom: 1em; }
    #summaryBox code { background-color: #e9ecef; padding: 2px 5px; border-radius: 3px; font-family: monospace; color: #333; direction: ltr; display: inline-block;}
    .dark-mode #summaryBox code { background-color: #3a3a3a; color: #f0f0f0; }
    .note-link { color: #007bff; cursor: pointer; text-decoration: underline; }
    .dark-mode .note-link { color: #4dabf7; }

    /* LaTeX Styles */
    .latex {
      color: #d63384; font-family: "Courier New", monospace;
      background-color: rgba(214, 51, 132, 0.1); padding: 2px 8px;
      border-radius: 4px; font-size: 1.1em; direction: ltr; display: inline-block;
      vertical-align: middle;
    }
    .math-container {
      margin: 20px 0; padding: 15px; background-color: rgba(248, 249, 250, 0.8);
      border-radius: 6px; border-right: 5px solid #d63384; border-left: none;
      overflow-x: auto; text-align: center; direction: ltr;
    }
    .dark-mode .latex { color: #ff6b9e; background-color: rgba(255, 107, 158, 0.1); }
    .dark-mode .math-container { background-color: rgba(30, 30, 30, 0.8); border-right-color: #ff6b9e; }

    /* Image Gallery Styles */
    #imageGallery { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 15px; }
    #imageGallery .img-container { position: relative; display: inline-block; border: 1px solid #ddd; border-radius: 5px; overflow: hidden; }
     .dark-mode #imageGallery .img-container { border: 1px solid #444; }

    #imageGallery img {
        display: block; width: 120px; height: 120px; object-fit: cover;
        cursor: pointer; transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }
    #imageGallery img:hover { transform: scale(1.05); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
    #imageGallery .delete-img-btn {
        position: absolute; top: 3px; right: 3px; width: 20px; height: 20px;
        background-color: rgba(220, 53, 69, 0.8); color: white; border: none;
        border-radius: 50%; font-size: 12px; line-height: 20px; text-align: center;
        cursor: pointer; opacity: 0; transition: opacity 0.2s ease-in-out; z-index: 1;
    }
     .dark-mode #imageGallery .delete-img-btn { background-color: rgba(167, 29, 42, 0.8); }
    #imageGallery .img-container:hover .delete-img-btn { opacity: 1; }

    .image-reorder-buttons {
        position: absolute;
        bottom: 3px;
        left: 3px; /* RTL: right: 3px */
        display: flex;
        flex-direction: column;
        gap: 2px;
        z-index: 1;
    }
     .image-reorder-buttons button {
         padding: 2px 5px;
         font-size: 10px;
         cursor: pointer;
         background-color: rgba(108, 117, 125, 0.8);
         color: white;
         border: none;
         border-radius: 3px;
         transition: 0.3s;
     }
      .dark-mode .image-reorder-buttons button { background-color: rgba(85, 85, 85, 0.8); }
     .image-reorder-buttons button:hover {
         background-color: #5a6268;
     }
      .dark-mode .image-reorder-buttons button:hover { background-color: #777; }

    /* Image Modal (Lightbox) Styles */
    .modal {
        display: none; position: fixed; z-index: 1500; padding-top: 50px;
        left: 0; top: 0; width: 100%; height: 100%; overflow: auto;
        background-color: rgba(0,0,0,0.85);
    }
    .modal-content { margin: auto; display: block; max-width: 85%; max-height: 85%; }
    .close-modal {
        position: absolute; top: 15px; right: 35px; color: #f1f1f1;
        font-size: 40px; font-weight: bold; transition: 0.3s; cursor: pointer;
    }
    .close-modal:hover, .close-modal:focus { color: #bbb; text-decoration: none; }
    .modal-nav {
        position: absolute; top: 50%; width: auto; padding: 16px; margin-top: -50px;
        color: white; font-weight: bold; font-size: 30px; transition: 0.3s ease;
        border-radius: 3px; user-select: none; -webkit-user-select: none; cursor: pointer;
        background-color: rgba(0, 0, 0, 0.4);
    }
    .modal-nav:hover { background-color: rgba(0, 0, 0, 0.7); }
    .prev-modal { left: 10px; border-radius: 3px 0 0 3px; }
    .next-modal { right: 10px; border-radius: 0 3px 3px 0; }

    /* Recording Status */
    #recordingStatus { color: red; font-weight: bold; margin-right: 10px; vertical-align: middle; }
    .dark-mode #recordingStatus { color: #ff4d4d; }

    .center-text { text-align: center; }
    .button-container { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }

    #floatingNoteButton {
      position: fixed;
      bottom: 80px;
      right: 25px; /* RTL: left: 25px */
      display: none;
      padding: 15px;
      font-size: 18px;
      cursor: pointer;
      border: none;
      border-radius: 50%;
      background-color: #007bff;
      color: white;
      transition: 0.3s;
      box-shadow: 0px 2px 5px rgba(0,0,0,0.2);
      font-family: 'Arial', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      vertical-align: middle;
      z-index: 1000;
    }
    #floatingNoteButton:hover {
      background-color: #0056b3;
    }

    #resetPageBtn {
        display: block;
        width: auto;
        margin: 30px auto 20px auto;
        padding: 12px 25px;
        font-size: 16px;
        cursor: pointer;
        border: none;
        border-radius: 5px;
        background-color: #ff4d4d;
        color: white;
        transition: 0.3s;
        box-shadow: 0px 2px 5px rgba(0,0,0,0.2);
        font-family: 'Arial', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    #resetPageBtn:hover {
        background-color: #cc0000;
    }

    /* CSS for Audio Options Menu */
    .audio-options-menu {
        position: absolute;
        background-color: #fff;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        z-index: 1010;
        padding: 8px;
        min-width: 150px;
    }
    .dark-mode .audio-options-menu {
        background-color: #2d2d2d;
        border-color: #444;
        color: #e0e0e0;
    }
    .audio-options-menu button, .audio-options-menu .custom-speed-controls button {
        display: block;
        width: 100%;
        padding: 6px 10px;
        margin-bottom: 4px;
        text-align: right;
        background-color: #f8f9fa;
        color: #333;
        border: 1px solid #ddd;
        border-radius: 3px;
        cursor: pointer;
        font-size: 13px;
        box-sizing: border-box;
    }
    .dark-mode .audio-options-menu button, .dark-mode .audio-options-menu .custom-speed-controls button {
        background-color: #3a3a3a;
        color: #e0e0e0;
        border-color: #555;
    }
    .audio-options-menu button:hover, .dark-mode .audio-options-menu .custom-speed-controls button:hover  {
        background-color: #e9ecef;
    }
    .dark-mode .audio-options-menu button:hover, .dark-mode .audio-options-menu .custom-speed-controls button:hover {
        background-color: #4f4f4f;
    }
     .custom-speed-controls {
        display: flex;
        align-items: center;
        gap: 5px;
        margin-top: 5px;
     }
    .audio-options-menu input[type="number"] {
        flex-grow: 1;
        padding: 5px;
        border: 1px solid #ccc;
        border-radius: 3px;
        font-size: 13px;
        direction: ltr;
        box-sizing: border-box;
        max-width: 70px;
    }
    .dark-mode .audio-options-menu input[type="number"] {
        background-color: #3a3a3a;
        color: #e0e0e0;
        border-color: #555;
    }

  </style>
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>

  <h2 class="center-text" style="margin-bottom: 15px; color: #007bff;">📺 مشغل فيديو متكامل + ملخص ذكي + ملاحظات وصور</h2>
   <p class="center-text" style="margin-top: -10px; margin-bottom: 20px; font-size: 14px; color: #6c757d;">
        ⚠️ لتسجيل الصوت: يجب السماح باستخدام الميكروفون عند الطلب، ويجب تشغيل الصفحة عبر HTTPS أو localhost.
   </p>

  <div class="center-text" style="margin-bottom: 25px;">
    <input type="text" id="videoUrl" placeholder="أدخل رابط فيديو يوتيوب" style="width: 65%; padding: 12px; max-width: 500px;">
    <button class="control-btn" onclick="loadVideo()">🎬 تشغيل الفيديو</button>
  </div>

  <div id="videoContainer"><p class="center-text" style="padding: 20px; color: #6c757d;">أدخل رابط فيديو يوتيوب واضغط "تشغيل الفيديو" للبدء.</p></div>

  <div class="speed-controls">
    <button class="control-btn speed-btn" onclick="changeSpeed(0.5)">0.5x</button>
    <button class="control-btn speed-btn" onclick="changeSpeed(0.75)">0.75x</button>
    <button class="control-btn speed-btn" onclick="changeSpeed(1)">1x</button>
    <button class="control-btn speed-btn" onclick="changeSpeed(1.25)">1.25x</button>
    <button class="control-btn speed-btn" onclick="changeSpeed(1.5)">1.5x</button>
    <button class="control-btn speed-btn" onclick="changeSpeed(2)">2x</button>
  </div>

  <div class="floating-controls">
    <button class="control-btn" onclick="seek(-10)">⏪ 10ث</button>
    <button class="control-btn" onclick="seek(10)">10ث ⏩</button>
  </div>

  <div class="floating-right-controls">
    <button class="control-btn" id="playPauseBtn" onclick="togglePlayPause()">▶ تشغيل</button>
  </div>

  <div class="notes-section">
    <h3 style="margin-top: 0; color: #17a2b8;">📝 الملاحظات</h3>
    <div id="noteTextEditable" contenteditable="true" class="editable-textarea-lookalike" placeholder="اكتب ملاحظة هنا..."></div>

    <div id="mainHighlightPalette">
        <button class="main-color-pink" onclick="applyHighlightToMainInput('#FFBABA')">أحمر فاتح</button>
        <button class="main-color-yellow" onclick="applyHighlightToMainInput('#FFFF99')">أصفر</button>
        <button class="main-color-green" onclick="applyHighlightToMainInput('#CCFFCC')">أخضر فاتح</button>
        <button class="main-color-blue" onclick="applyHighlightToMainInput('#CCEEFF')">أزرق فاتح</button>
        <button class="main-color-orange" onclick="applyHighlightToMainInput('#FFDAB9')">برتقالي فاتح</button>
        <button onclick="removeHighlightFromMainInput()">إزالة اللون</button>
    </div>

    <div style="margin-top: 10px; display: flex; align-items: center; flex-wrap: wrap; gap: 10px;">
        <button class="control-btn" onclick="saveNote()">💾 حفظ الملاحظة النصية</button>
        <button id="recordNoteBtn" class="record-btn" onclick="toggleRecording()">🎤 تسجيل ريكورد</button>
        <label for="audioUploadInput" class="control-btn" style="background-color: #5cb85c; cursor:pointer;">📤 رفع تسجيل صوتي</label>
        <input type="file" id="audioUploadInput" accept="audio/*" multiple style="display: none;">
        <span id="recordingStatus" style="display:none;">🔴 جاري التسجيل...</span>
    </div>
  </div>

  <ul id="notesList"></ul>

  <div class="lecture-images-section">
      <h3 style="margin-top: 0; color: #6f42c1;">🖼️ صور المحاضرة</h3>
      <label for="imageUpload" class="control-btn" style="display: inline-block; margin-bottom: 15px;">➕ إضافة صور</label>
      <input type="file" id="imageUpload" accept="image/*" multiple style="display: none;">
      <div id="imageGallery">
          </div>
  </div>

  <div id="imageModal" class="modal">
        <span class="close-modal" onclick="closeModal()">×</span>
        <img class="modal-content" id="modalImage">
        <a class="modal-nav prev-modal" onclick="changeModalImage(-1)">❮</a>
        <a class="modal-nav next-modal" onclick="changeModalImage(1)">❯</a>
    </div>

  <div class="search-box">
    <h3 style="margin-top: 0; color: #d63384;">🔍 بحث في محتوى الفيديو</h3>
    <input type="text" id="searchText" placeholder="ابحث في نص الفيديو...">
    <button class="control-btn" onclick="searchInText()">بحث</button>
    <button class="clear-search-btn" onclick="clearSearch()" id="clearSearchBtn" style="display:none;">✖ مسح البحث</button>
    <div id="searchResults" style="margin-top: 15px; text-align: right;"></div>
  </div>

  <div style="margin-top: 25px;" class="notes-section"> <h3 style="margin-bottom: 15px; color: #6f42c1;">📌 النص الكامل (أو الصقه هنا):</h3>
    <textarea id="transcriptInput" placeholder="انتظر جلب الترجمة أو الصق النص الكامل هنا..." style="height: 180px;"></textarea>
    <div style="margin-top:10px; text-align: center;">
        <button class="control-btn" onclick="summarizeText()">📝 توليد ملخص للنص أعلاه</button>
    </div>
  </div>

  <div id="summaryBox" class="notes-section" style="margin-top: 25px; min-height: 150px;">
      <h3 style="margin-top: 0; color: #007bff;">💡 الملخص الذكي</h3>
      <div id="summaryContent">🔍 لم يتم توليد ملخص بعد.</div> </div>

  <div class="center-text button-container" style="margin-top: 30px; padding-bottom: 20px;">
      <button class="control-btn" onclick="toggleDarkMode()" style="padding: 12px 25px;">🌙 تبديل الوضع</button>
      <button id="downloadPageBtn" class="control-btn" onclick="downloadPage()" style="padding: 12px 25px; background-color: #28a745;" title="حفظ الكود الحالي للصفحة بما فيه من ملاحظات وصور كملف HTML واحد">📥 حفظ الصفحة كـ HTML</button>
      <button id="exportBtn" class="control-btn" onclick="exportData()" style="padding: 12px 25px; background-color: #ff9800;">📤 تصدير البيانات</button>
      <button id="importBtn" class="control-btn" onclick="importData()" style="padding: 12px 25px; background-color: #9c27b0;">📥 استرداد البيانات</button>
      <button id="toggleFloatingNoteBtn" class="control-btn" onclick="toggleFloatingNoteButton()" style="padding: 12px 25px; background-color: #e91e63;">🔄 تفعيل الزر العائم</button>
  </div>

  <button id="resetPageBtn" onclick="resetPage()">🧹 إعادة تعيين الصفحة</button>

  <button id="floatingNoteButton" onclick="toggleNotesSection()">📝</button>

  <script>
    const OPENROUTER_API_KEY = "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"; // !!! استبدل بمفتاحك الحقيقي بشكل آمن
    let player;
    let notes = [];
    let captionsData = [];
    let isPlaying = false;
    let currentHighlights = [];
    let lectureImages = [];
    let currentModalIndex = -1;
    let currentVideoUrl = '';
    let savedVideoTime = 0;

    let mediaRecorder;
    let audioChunks = [];
    let isRecording = false;
    let audioStream = null;

    // Variables for text note editing
    let originalNoteHTML = '';
    let currentlyEditingNoteIndex = -1;


    // --- YouTube API Handling ---
    function loadYouTubeAPI() {
      if (typeof YT === 'undefined' || typeof YT.Player === 'undefined') {
        console.log("Loading YouTube API...");
        const tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        const firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
      } else {
        console.log("YouTube API already loaded.");
        if (typeof YT.Player === 'function' && typeof YT.PlayerState !== 'undefined') {
           onYouTubeIframeAPIReady();
        }
      }
    }
    function onYouTubeIframeAPIReady() {
      console.log("YouTube IFrame API Ready.");
      if (currentVideoUrl) {
          document.getElementById("videoUrl").value = currentVideoUrl;
          setTimeout(() => loadVideo(currentVideoUrl), 100);
      }
    }

    function loadVideo(url) {
      const videoUrlInput = document.getElementById("videoUrl");
      const urlToLoad = url || videoUrlInput.value;
      if (!urlToLoad) return alert("❌ يرجى إدخال رابط فيديو يوتيوب صحيح.");
      const videoId = extractVideoID(urlToLoad);
      if (!videoId) return alert("❌ يرجى إدخال رابط يوتيوب صحيح.");

      currentVideoUrl = urlToLoad;

      if (player && typeof player.destroy === 'function') {
          try { player.destroy(); player = null; console.log("Previous player destroyed.");}
          catch (e) { console.error("Error destroying previous player:", e); }
      }
       const videoContainer = document.getElementById("videoContainer");
       if (!videoContainer) {
           console.error("Video container element not found!");
           alert("❌ خطأ داخلي: عنصر مشغل الفيديو مفقود.");
           return;
       }
       videoContainer.innerHTML = '<div id="youtubePlayer"></div><p id="playerStatus" style="text-align:center; padding: 10px; color: #6c757d;">⏳ جاري تحميل الفيديو...</p>';

      resetAppState(false);

      if (typeof YT !== 'undefined' && YT.Player) { createPlayer(videoId); }
      else {
          console.warn("YT API not ready when loadVideo called. Waiting...");
          const playerStatusEl = document.getElementById("playerStatus");
          if (playerStatusEl) playerStatusEl.innerText = "⏳ واجهة يوتيوب قيد التحميل، يرجى الانتظار...";
           setTimeout(() => {
              if (!player && typeof YT !== 'undefined' && YT.Player) { createPlayer(videoId); }
              else if (!player) {
                   console.error("YT API did not become ready.");
                    const statusEl = document.getElementById("playerStatus");
                    if (statusEl) statusEl.innerText = "❌ فشل تحميل واجهة يوتيوب. حاول تحديث الصفحة.";
                    alert("❌ فشل تحميل واجهة يوتيوب. حاول تحديث الصفحة.");
              }
           }, 4000);
      }
    }
    function createPlayer(videoId) {
        try {
            player = new YT.Player('youtubePlayer', {
                height: '450', width: '100%', videoId: videoId,
                playerVars: { 'playsinline': 1 },
                events: { 'onReady': onPlayerReady, 'onStateChange': onPlayerStateStateChange, 'onError': onPlayerError }
            });
            console.log("YT.Player instance requested.");
        } catch (e) {
            console.error("Error creating YT.Player instance:", e);
            const statusEl = document.getElementById("playerStatus");
            if (statusEl) statusEl.innerText = "❌ خطأ في إنشاء مشغل الفيديو.";
            alert("❌ حدث خطأ أثناء تهيئة مشغل الفيديو.");
        }
    }
    function onPlayerReady(event) {
        player = event.target;
        console.log("Player ready (onReady event).");
        const statusEl = document.getElementById("playerStatus");
        if (statusEl) statusEl.remove();
        isPlaying = (player.getPlayerState() === YT.PlayerState.PLAYING);
        updatePlayPauseButton();

        if (savedVideoTime > 0) {
            try {
                player.seekTo(savedVideoTime, true);
                console.log(`Seeking to saved time (session only): ${formatTime(savedVideoTime)}`);
                savedVideoTime = 0;
            } catch (e) {
                console.error("Error seeking to saved time:", e);
            }
        }
    }
    function onPlayerError(event) {
        console.error("YouTube Player Error Code:", event.data);
        let errorMsg = `❌ حدث خطأ في مشغل يوتيوب (رمز الخطأ: ${event.data}).`;
        switch(event.data) {
            case 2: errorMsg += " طلب غير صالح."; break;
            case 5: errorMsg += " خطأ في مشغل HTML5."; break;
            case 100: case 101: case 150: errorMsg += " الفيديو غير موجود أو خاص أو لا يمكن تضمينه."; break;
            default: errorMsg += " خطأ غير معروف.";
        }
        const videoContainerInner = document.getElementById("videoContainer");
        if (videoContainerInner) videoContainerInner.innerHTML = `<p style="color: red; text-align: center; padding: 20px;">${errorMsg}</p>`;
        player = null; isPlaying = false; updatePlayPauseButton();
        currentVideoUrl = '';
        savedVideoTime = 0;
    }
    function extractVideoID(url) {
        const regex = /(?:youtube(?:-nocookie)?\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|watch(?:\?v=|\/))|youtu\.be\/|youtube\.com\/shorts\/)([a-zA-Z0-9_-]{11})/;
        return (url.match(regex) || [])[1] || null;
    }
    function onPlayerStateStateChange(event) {
        isPlaying = (event.data == YT.PlayerState.PLAYING);
        updatePlayPauseButton();
    }
    function togglePlayPause() {
        if (!player || typeof player.getPlayerState !== 'function') return alert("❌ المشغل غير جاهز.");
        try {
            const state = player.getPlayerState();
            if (state === YT.PlayerState.PLAYING) player.pauseVideo();
            else player.playVideo();
        } catch (e) { console.error("Error toggling play/pause:", e); alert("❌ خطأ في التشغيل/الإيقاف."); }
    }
    function updatePlayPauseButton() {
        const btn = document.getElementById("playPauseBtn");
        if (btn) btn.innerHTML = isPlaying ? "⏸ إيقاف" : "▶ تشغيل";
    }
    function changeSpeed(speed) {
        if (!player || typeof player.setPlaybackRate !== 'function') return alert("❌ المشغل غير جاهز.");
        try { player.setPlaybackRate(speed); console.log("Playback rate set to:", speed); }
        catch (e) { console.error("Error setting playback rate:", e); alert("❌ خطأ في تغيير السرعة."); }
    }
    function seek(seconds) {
        if (!player || typeof player.seekTo !== 'function') return alert("❌ المشغل غير جاهز.");
        try {
            let currentTime = player.getCurrentTime() || 0;
            let newTime = Math.max(0, currentTime + seconds);
            const duration = player.getDuration();
            if (duration && newTime > duration) newTime = duration;
            player.seekTo(newTime, true);
        } catch (e) { console.error("Error seeking:", e); alert("❌ خطأ في الانتقال."); }
    }

    // --- Transcript & Search ---
    async function fetchTranscript(videoId) {
        document.getElementById("transcriptInput").value = "⚠️ يرجى لصق نص الترجمة هنا.";
        captionsData = [];
    }

    function parseTranscriptWithTimestamps(transcript) {
        const lines = transcript.split('\n');
        const data = [];
        const srtTimeRegex = /(\d{1,2}):(\d{2}):(\d{2}),(\d{3})\s*-->\s*\d{1,2}:\d{2}:\d{2},\d{3}(.*)/;
        const simpleTimeRegex = /^(\d{1,2}):(\d{2}(\.\d+)?)\s*(.*)/;

        lines.forEach(line => {
            const srtMatch = line.match(srtTimeRegex);
            const simpleMatch = line.match(simpleTimeRegex);

            if (srtMatch) {
                const hours = parseInt(srtMatch[1], 10);
                const minutes = parseInt(srtMatch[2], 10);
                const seconds = parseInt(srtMatch[3], 10);
                const milliseconds = parseInt(srtMatch[4], 10);
                const timeInSeconds = (hours * 3600) + (minutes * 60) + seconds + (milliseconds / 1000);
                const text = srtMatch[5].trim();
                if (text) data.push({ time: timeInSeconds, text: text });

            } else if (simpleMatch) {
                const minutes = parseInt(simpleMatch[1], 10);
                const secondsValue = parseFloat(simpleMatch[2]);
                const timeInSeconds = (minutes * 60) + secondsValue;
                const text = simpleMatch[4].trim();
                if (text) data.push({ time: timeInSeconds, text: text });

            } else if (line.trim() !== '' && data.length > 0) {
                data[data.length - 1].text += '\n' + line.trim();
            }
        });
        return data;
    }

    function searchInText() {
        const query = document.getElementById("searchText").value.trim();
        if (!query) return alert("❌ يرجى إدخال نص للبحث");
        const transcriptArea = document.getElementById("transcriptInput");
        const transcript = transcriptArea.value;
        if (!transcript || transcript.includes("⏳") || transcript.includes("⚠️")) {
            return alert("❌ لا يوجد نص صالح للبحث فيه");
        }
        clearSearchHighlights();

        const currentTranscriptData = parseTranscriptWithTimestamps(transcript);
        let resultsHTML = '';
        let foundCount = 0;
        currentHighlights = [];
        const queryLower = query.toLowerCase();

        currentTranscriptData.forEach((item, index) => {
            if (item.text.toLowerCase().includes(queryLower)) {
                foundCount++;
                const highlightedTextHTML = highlightText(item.text, query);
                let jumpTime = item.time;

                resultsHTML += `<div class="highlight-line" onclick="jumpTo(${jumpTime})">
                    <b>[${formatTime(jumpTime)}]</b> ${highlightedTextHTML}
                    <button class="control-btn" style="padding: 2px 6px !important; font-size: 12px !important; margin-left: 5px;">🔗</button>
                  </div>`;
            }
        });

        const searchResultsDiv = document.getElementById("searchResults");
        if (foundCount > 0) {
            searchResultsDiv.innerHTML = `<p>تم العثور على ${foundCount} نتائج:</p>${resultsHTML}`;
            document.getElementById("clearSearchBtn").style.display = 'inline-block';

             searchResultsDiv.querySelectorAll('.highlight-line button').forEach(button => {
                 button.addEventListener('click', function(event) {
                      event.stopPropagation();
                      const jumpTimeAttr = this.closest('.highlight-line').getAttribute('onclick');
                      if (jumpTimeAttr) {
                          const match = jumpTimeAttr.match(/jumpTo\(([^)]+)\)/);
                          if (match && match[1]) {
                            const jumpTimeValue = parseFloat(match[1]);
                            if (!isNaN(jumpTimeValue)) jumpTo(jumpTimeValue);
                          }
                      }
                 });
             });
        } else {
            searchResultsDiv.innerHTML = "⚠️ لم يتم العثور على نتائج";
            document.getElementById("clearSearchBtn").style.display = 'none';
        }
    }

    function clearSearch() {
        clearSearchHighlights();
        document.getElementById("searchResults").innerHTML = '';
        document.getElementById("searchText").value = '';
        document.getElementById("clearSearchBtn").style.display = 'none';
        const textarea = document.getElementById("transcriptInput");
        try { textarea.setSelectionRange(0,0); textarea.scrollTop = 0; } catch(e){}
    }
    function clearSearchHighlights() {
         const searchResultsDiv = document.getElementById("searchResults");
         if (searchResultsDiv) {
             searchResultsDiv.innerHTML = '';
         }
    }
    function highlightText(text, query) {
        if (!query) return text;
        try {
            const safeQuery = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const regex = new RegExp(`(${safeQuery})`, 'gi');
             return text.replace(regex, '<span class="highlight">$1</span>');
        } catch (e) {
            console.error("Error highlighting text:", e);
            return text;
        }
    }
    function escapeRegExp(string) {
         return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    // --- Summarization ---
    async function summarizeText() {
         const text = document.getElementById("transcriptInput").value;
          if (!text || text.includes("⏳") || text.includes("⚠️")) {
              return alert("❌ يرجى إدخال نص الترجمة أو الانتظار حتى يتم جلبه.");
          }
          const summaryContainer = document.getElementById("summaryContent");
          summaryContainer.innerHTML = "⏳ جاري تلخيص المحتوى باستخدام DeepSeek...";
          try {
            const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
              method: "POST",
              headers: {
                "Authorization": `Bearer ${OPENROUTER_API_KEY}`, "Content-Type": "application/json",
                "HTTP-Referer": window.location.href,
                "X-Title": "Video Summarizer Tool",
              },
              body: JSON.stringify({
                "model": "deepseek/deepseek-coder",
                "messages": [{
                  "role": "system", "content": `أنت مساعد ذكاء اصطناعي متخصص في تلخيص المحتوى التعليمي، خاصة المحاضرات التقنية. لخص النص بدقة مع الحفاظ على جميع القوانين والمعادلات الرياضية بصيغة LaTeX كما هي تماماً. استخدم العناوين والقوائم لتحسين قابلية القراءة.`
                }, {
                  "role": "user", "content": `لخص النص التالي مع التركيز على النقاط الرئيسية والقوانين والمعادلات الرياضية باستخدام LaTeX:\n\n${text}`
                }]
              })
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`فشل طلب التلخيص: ${response.status} ${response.statusText}. ${errorData.error?.message || ''}`);
            }
            const data = await response.json();
            if (!data.choices?.[0]?.message?.content) { throw new Error("لم يتم العثور على محتوى الملخص في استجابة الـ API."); }
            let summary = data.choices[0].message.content;
            summary = processSummaryContent(summary);
            summaryContainer.innerHTML = summary;
            renderMathInElement(summaryContainer);
          } catch (error) {
            summaryContainer.innerHTML = `❌ حدث خطأ أثناء جلب الملخص: ${error.message}`;
            console.error(error);
          }
    }
    function processSummaryContent(summary) {
        summary = summary
          .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
          .replace(/\*(.*?)\*/g, '<i>$1</i>')
          .replace(/`(.*?)`/g, '<code>$1</code>');

        summary = summary.replace(/^### (.*$)/gim, '<h4>$1</h4>')
                         .replace(/^## (.*$)/gim, '<h3>$1</h3>')
                         .replace(/^# (.*$)/gim, '<h2>$1</h2>');

        summary = summary.replace(/^\s*-\s+(.*)/gm, '<li>$1</li>')
                         .replace(/^\s*\d+\.\s+(.*)/gm, '<li>$1</li>');

        summary = summary.replace(/((<li>.*?<\/li>\s*)+)/gs, (match) => {
             const isOrdered = /^\s*\d+\./m.test(match.replace(/<li>/g, "1. "));
             return isOrdered ? `<ol>${match}</ol>` : `<ul>${match}</ul>`;
        });

        summary = summary.split('\n').map(line => {
            if (line.trim().startsWith('<li') || line.trim().startsWith('<h') || line.trim() === '' || line.includes('<code>') || line.includes('</code>') || line.trim().startsWith('<ul') || line.trim().startsWith('</ul') || line.trim().startsWith('<ol') || line.trim().startsWith('</ol')) {
                return line;
            }
             if (line.trim().startsWith('<div class="math-container">') || line.trim().startsWith('<span class="latex">')) {
                 return line;
             }
            return line + '<br>';
        }).join('');


        summary = formatMathEquations(summary);
        summary = summary.replace(/<br>\s*<(ul|ol|div class="math-container")>/g, '<$1>').replace(/<\/(ul|ol|div class="math-container")>\s*<br>/g, '</$1>');
        return summary;
    }

    function formatMathEquations(text) {
        text = text.replace(/\\\[([\s\S]*?)\\\]/g, (m, eq) => `<div class="math-container">\\[${eq.trim()}\\]</div>`);
        text = text.replace(/\\\((.*?)\\\)/g, (m, eq) => eq.trim() ? `<span class="latex">\\(${eq.trim()}\\)</span>` : '');
        return text;
    }
    function renderMathInElement(element) {
         if (element && (element.innerHTML.includes('\\(') || element.innerHTML.includes('\\['))) {
             if (typeof MathJax !== 'undefined' && MathJax.typesetPromise) {
                MathJax.typesetPromise([element]).catch((err) => console.error('MathJax error:', err));
            } else {
                if (typeof MathJax !== 'undefined' && MathJax.typeset) {
                    MathJax.typeset([element]);
                }
            }
         }
    }

    // --- Main Input Area Highlighting ---
    function applyHighlightToMainInput(color) {
        const editor = document.getElementById('noteTextEditable');
        editor.focus();
        document.execCommand('styleWithCSS', false, true);
        document.execCommand('backColor', false, color);
    }

    function removeHighlightFromMainInput() {
        const editor = document.getElementById('noteTextEditable');
        editor.focus();
        document.execCommand('styleWithCSS', false, true);
        document.execCommand('backColor', false, 'transparent');
    }

    // --- Notes Management ---
    function saveNote() {
        const noteEditor = document.getElementById("noteTextEditable");
        const noteHTML = noteEditor.innerHTML; // Get HTML content from contenteditable div

        // Check for effective emptiness (ignoring empty tags or just <br>)
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = noteHTML;
        if (!tempDiv.textContent.trim() && !tempDiv.querySelector('img')) { // Check textContent and if any images exist
             // A more robust check might be needed if complex empty structures are possible
             let plainText = noteHTML.replace(/<[^>]*>/g, "").trim(); // Strip all tags and trim
             if (!plainText) {
                alert("❌ يرجى كتابة ملاحظة قبل الحفظ.");
                return;
             }
        }


        let noteTime;
        if (player && typeof player.getCurrentTime === 'function' && currentVideoUrl) {
             try { noteTime = player.getCurrentTime(); }
             catch (e) { console.warn("Error getting player time for text note, using current time.", e); noteTime = Date.now() / 1000; }
        } else {
            noteTime = Date.now() / 1000;
        }

        notes.push({ time: noteTime, type: 'text', text: noteHTML }); // Save HTML content
        updateNotesList();
        noteEditor.innerHTML = ""; // Clear the contenteditable div
    }

     async function toggleRecording() {
        const recordBtn = document.getElementById('recordNoteBtn');
        const statusIndicator = document.getElementById('recordingStatus');
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            return alert('❌ متصفحك لا يدعم تسجيل الصوت.');
        }
        if (!window.isSecureContext) {
             return alert('❌ لا يمكن تسجيل الصوت إلا من صفحة آمنة (HTTPS) أو localhost.');
        }

        if (isRecording) {
            try {
                if (mediaRecorder?.state === "recording") mediaRecorder.stop();
                if(audioStream) audioStream.getTracks().forEach(track => track.stop()); audioStream = null;
            } catch (e) { console.error("Error stopping recording:", e); }
            finally {
                 if (recordBtn) { recordBtn.classList.remove('recording'); recordBtn.innerHTML = '🎤 تسجيل ريكورد';}
                 if (statusIndicator) statusIndicator.style.display = 'none';
                 isRecording = false;
            }
        } else {
            let recordingStartTime;
            if (player && typeof player.getCurrentTime === 'function' && currentVideoUrl) {
                try { recordingStartTime = player.getCurrentTime(); }
                catch(e) { console.warn("Failed to get player time for recording, using current time.", e); recordingStartTime = Date.now() / 1000;}
            } else {
                 recordingStartTime = Date.now() / 1000;
            }

            try {
                audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(audioStream, { mimeType: 'audio/webm; codecs=opus' });
                audioChunks = [];
                mediaRecorder.ondataavailable = e => { if (e.data.size > 0) audioChunks.push(e.data); };
                mediaRecorder.onstop = () => {
                    if (audioChunks.length === 0 || audioChunks.reduce((acc, chunk) => acc + chunk.size, 0) < 100) {
                        alert("⚠️ لم يتم تسجيل أي بيانات صوتية أو أن التسجيل قصير جداً.");
                        if(audioStream) audioStream.getTracks().forEach(track => track.stop()); audioStream = null;
                        audioChunks = [];
                        if (recordBtn) { recordBtn.classList.remove('recording'); recordBtn.innerHTML = '🎤 تسجيل ريكورد'; }
                        if (statusIndicator) statusIndicator.style.display = 'none';
                        isRecording = false;
                        return;
                    }
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm; codecs=opus' });

                    const reader = new FileReader();
                    reader.onloadend = () => {
                        notes.push({
                            time: recordingStartTime,
                            type: 'audio',
                            data: reader.result,
                            filename: `تسجيل-${new Date().toISOString().slice(0,19).replace('T','-')}.webm`,
                            annotation: "",
                            uploaded: false
                        });
                        updateNotesList();
                        audioChunks = [];
                    };
                    reader.onerror = (error) => {
                        console.error("FileReader error:", error);
                        alert("❌ خطأ في معالجة الصوت.");
                        audioChunks = [];
                    };
                    reader.readAsDataURL(audioBlob);

                    if(audioStream) audioStream.getTracks().forEach(track => track.stop()); audioStream = null;
                };
                 mediaRecorder.onerror = (event) => {
                     console.error("MediaRecorder Error:", event.error); alert(`❌ خطأ في مسجل الصوت: ${event.error.name}`);
                     if(audioStream) audioStream.getTracks().forEach(track => track.stop()); audioStream = null;
                     if (recordBtn) { recordBtn.classList.remove('recording'); recordBtn.innerHTML = '🎤 تسجيل ريكورد';}
                     if (statusIndicator) statusIndicator.style.display = 'none';
                     isRecording = false;
                 };
                mediaRecorder.start();
                if (recordBtn) {recordBtn.classList.add('recording'); recordBtn.innerHTML = '⏹ إيقاف التسجيل';}
                if (statusIndicator) statusIndicator.style.display = 'inline';
                isRecording = true;
            } catch (err) {
                console.error('Error starting recording:', err); isRecording = false;
                if (recordBtn) { recordBtn.classList.remove('recording'); recordBtn.innerHTML = '🎤 تسجيل ريكورد';}
                if (statusIndicator) statusIndicator.style.display = 'none';
                if(audioStream) audioStream.getTracks().forEach(track => track.stop()); audioStream = null;
                handleRecordingError(err);
            }
        }
    }
    function handleRecordingError(err) {
        if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') alert('❌ تم رفض إذن الميكروفون. يرجى السماح به في إعدادات المتصفح.');
        else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') alert('❌ لم يتم العثور على ميكروفون.');
        else if (err.name === 'NotReadableError' || err.name === 'TrackStartError') alert('❌ خطأ في قراءة الميكروفون (قد يكون مستخدماً من قبل تطبيق آخر).');
        else if (err.name === 'SecurityError') alert('❌ خطأ أمني (تأكد من أن الصفحة تعمل عبر HTTPS أو localhost).');
        else if (err.name === 'AbortError') alert('⚠️ تم إحباط بدء التسجيل.');
        else alert(`❌ خطأ غير متوقع في بدء التسجيل: ${err.name} - ${err.message}`);
    }

    // --- Audio Upload from Device ---
    function setupAudioUpload() {
        const audioUploadInput = document.getElementById('audioUploadInput');
        if (audioUploadInput) {
            audioUploadInput.addEventListener('change', handleAudioUpload);
        }
    }

    async function handleAudioUpload(event) {
        const files = event.target.files;
        if (!files || files.length === 0) return;

        for (const file of Array.from(files)) {
            if (!file.type.startsWith('audio/')) {
                alert(`❌ الملف "${file.name}" ليس ملف صوتي صالح.`);
                continue;
            }

            let noteTime;
            if (player && typeof player.getCurrentTime === 'function' && currentVideoUrl) {
                try { noteTime = player.getCurrentTime(); }
                catch (e) { console.warn("Error getting player time for uploaded audio, using current time.", e); noteTime = Date.now() / 1000;}
            } else {
                noteTime = Date.now() / 1000;
            }

            try {
                const reader = new FileReader();
                const dataUrl = await new Promise((resolve, reject) => {
                    reader.onloadend = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
                notes.push({
                    time: noteTime,
                    type: 'audio',
                    data: dataUrl,
                    filename: file.name,
                    annotation: "",
                    uploaded: true
                });
            } catch (error) {
                console.error("Error reading uploaded audio file:", file.name, error);
                alert(`❌ خطأ في قراءة الملف الصوتي: ${file.name}`);
            }
        }
        updateNotesList();
        event.target.value = '';
    }

    // --- Text Note Editing and Highlighting (In-List) ---
    function toggleEditNote(index, editBtnEl) {
        const listItem = document.querySelector(`#notesList li[data-note-index="${index}"]`);
        if (!listItem) return;

        const editableDiv = listItem.querySelector('.text-note-content-editable');
        const textNoteActions = listItem.querySelector('.text-note-actions');
        const highlightPalette = textNoteActions.querySelector('.highlight-palette');
        const saveBtn = textNoteActions.querySelector('.save-text-note-btn');
        const cancelBtn = textNoteActions.querySelector('.cancel-text-note-btn');

        if (editableDiv.isContentEditable) {
            editableDiv.innerHTML = originalNoteHTML;
            editableDiv.contentEditable = false;
            highlightPalette.style.display = 'none';
            saveBtn.style.display = 'none';
            cancelBtn.style.display = 'none';
            editBtnEl.innerHTML = '✏️ تعديل النص';
            editBtnEl.style.display = 'inline-block';
            currentlyEditingNoteIndex = -1;
        } else {
            if (currentlyEditingNoteIndex !== -1 && currentlyEditingNoteIndex !== index) {
                const prevListItem = document.querySelector(`#notesList li[data-note-index="${currentlyEditingNoteIndex}"]`);
                if (prevListItem) {
                    cancelEditNote(currentlyEditingNoteIndex);
                }
            }
            originalNoteHTML = editableDiv.innerHTML;
            editableDiv.contentEditable = true;
            editableDiv.focus();
            highlightPalette.style.display = 'flex';
            saveBtn.style.display = 'inline-block';
            cancelBtn.style.display = 'inline-block';
            editBtnEl.style.display = 'none';
            currentlyEditingNoteIndex = index;
        }
    }

    function applyHighlightToNoteInList(noteIndex, color) { // Renamed for clarity
        const listItem = document.querySelector(`#notesList li[data-note-index="${noteIndex}"]`);
        if (!listItem) return;
        const editableDiv = listItem.querySelector('.text-note-content-editable');
        if (!editableDiv || !editableDiv.isContentEditable) return;

        const selection = window.getSelection();
        if (!selection.rangeCount) return;
        const range = selection.getRangeAt(0);

        if (!editableDiv.contains(range.commonAncestorContainer) && !selection.isCollapsed) {
             alert("يجب أن يكون النص المحدد بالكامل داخل صندوق الملاحظة.");
             return;
        }
        editableDiv.focus();
        document.execCommand('styleWithCSS', false, true);
        document.execCommand('backColor', false, color);
    }

    function removeHighlightFromSelectionInList(noteIndex) { // Renamed for clarity
        const listItem = document.querySelector(`#notesList li[data-note-index="${noteIndex}"]`);
        if (!listItem) return;
        const editableDiv = listItem.querySelector('.text-note-content-editable');
        if (!editableDiv || !editableDiv.isContentEditable) return;

        const selection = window.getSelection();
         if (!selection.rangeCount) return;
         const range = selection.getRangeAt(0);

        if (!editableDiv.contains(range.commonAncestorContainer) && !selection.isCollapsed) {
             alert("يجب أن يكون النص المحدد بالكامل داخل صندوق الملاحظة.");
             return;
        }
        editableDiv.focus();
        document.execCommand('styleWithCSS', false, true);
        document.execCommand('backColor', false, 'transparent');
    }

    function saveEditedNote(index) {
        const listItem = document.querySelector(`#notesList li[data-note-index="${index}"]`);
        if (!listItem) return;
        const editableDiv = listItem.querySelector('.text-note-content-editable');
        const editBtn = listItem.querySelector('.edit-text-note-btn');
        const highlightPalette = listItem.querySelector('.highlight-palette');
        const saveBtn = listItem.querySelector('.save-text-note-btn');
        const cancelBtn = listItem.querySelector('.cancel-text-note-btn');

        notes[index].text = editableDiv.innerHTML;
        editableDiv.contentEditable = false;

        highlightPalette.style.display = 'none';
        saveBtn.style.display = 'none';
        cancelBtn.style.display = 'none';
        if (editBtn) { // Check if editBtn exists (it should)
             editBtn.innerHTML = '✏️ تعديل النص';
             editBtn.style.display = 'inline-block';
        }
        currentlyEditingNoteIndex = -1;
        console.log("Note saved:", notes[index]);
    }

    function cancelEditNote(index) {
        const listItem = document.querySelector(`#notesList li[data-note-index="${index}"]`);
        if (!listItem) return;
        const editableDiv = listItem.querySelector('.text-note-content-editable');
        const textNoteActions = listItem.querySelector('.text-note-actions');
        if (!textNoteActions) return; // Should not happen if structure is correct

        const highlightPalette = textNoteActions.querySelector('.highlight-palette');
        const saveBtn = textNoteActions.querySelector('.save-text-note-btn');
        const cancelBtn = textNoteActions.querySelector('.cancel-text-note-btn');
        const editBtn = textNoteActions.querySelector('.edit-text-note-btn');


        editableDiv.innerHTML = originalNoteHTML;
        editableDiv.contentEditable = false;

        if(highlightPalette) highlightPalette.style.display = 'none';
        if(saveBtn) saveBtn.style.display = 'none';
        if(cancelBtn) cancelBtn.style.display = 'none';
        if(editBtn) editBtn.style.display = 'inline-block';

        currentlyEditingNoteIndex = -1;
    }


    function updateNotesList() {
        const notesListElement = document.getElementById("notesList");
        if (!notesListElement) return;

        if (currentlyEditingNoteIndex !== -1) {
            const prevListItem = document.querySelector(`#notesList li[data-note-index="${currentlyEditingNoteIndex}"]`);
            if (prevListItem) {
                 cancelEditNote(currentlyEditingNoteIndex);
            }
        }

        notesListElement.innerHTML = "";
        closeAllAudioOptionMenus();

        notes.forEach((note, index) => {
            let listItem = document.createElement("li");
            listItem.setAttribute('data-note-index', index);

            const reorderButtons = document.createElement('div');
            reorderButtons.className = 'reorder-buttons';
            const upButton = document.createElement('button');
            upButton.innerHTML = '▲'; upButton.title = 'تحريك لأعلى';
            upButton.onclick = () => moveNoteUp(index);
            if (index === 0) upButton.disabled = true;
            const downButton = document.createElement('button');
            downButton.innerHTML = '▼'; downButton.title = 'تحريك لأسفل';
            downButton.onclick = () => moveNoteDown(index);
            if (index === notes.length - 1) downButton.disabled = true;
            reorderButtons.appendChild(upButton); reorderButtons.appendChild(downButton);

            const noteContent = document.createElement('div');
            noteContent.className = 'note-content';
            let timePrefixHTML = `<b>[${formatTime(note.time)}]</b> `;


            if (note.type === 'text') {
                noteContent.innerHTML = timePrefixHTML + `ملاحظة نصية:`;

                const editableDiv = document.createElement('div');
                editableDiv.className = 'text-note-content-editable';
                editableDiv.setAttribute('data-note-index', index);
                editableDiv.contentEditable = false;
                editableDiv.innerHTML = note.text; // note.text contains HTML
                noteContent.appendChild(editableDiv);

                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'text-note-actions';

                const editBtn = document.createElement('button');
                editBtn.className = 'control-btn edit-text-note-btn';
                editBtn.innerHTML = '✏️ تعديل النص';
                editBtn.onclick = () => toggleEditNote(index, editBtn);
                actionsDiv.appendChild(editBtn);

                const paletteDiv = document.createElement('div');
                paletteDiv.className = 'highlight-palette';
                paletteDiv.style.display = 'none';
                const colors = [
                    { name: 'وردي', value: '#FFBABA', class: 'color-lightpink'},
                    { name: 'أصفر', value: '#FFFF99', class: 'color-yellow'},
                    { name: 'أخضر', value: '#CCFFCC', class: 'color-lightgreen'},
                    { name: 'أزرق', value: '#CCEEFF', class: 'color-lightblue'}
                ];
                colors.forEach(color => {
                    const colorBtn = document.createElement('button');
                    colorBtn.textContent = color.name;
                    colorBtn.className = color.class;
                    colorBtn.onclick = () => applyHighlightToNoteInList(index, color.value);
                    paletteDiv.appendChild(colorBtn);
                });
                const removeHighlightBtn = document.createElement('button');
                removeHighlightBtn.textContent = 'إزالة اللون';
                removeHighlightBtn.onclick = () => removeHighlightFromSelectionInList(index);
                paletteDiv.appendChild(removeHighlightBtn);
                actionsDiv.appendChild(paletteDiv);

                const saveBtn = document.createElement('button');
                saveBtn.className = 'control-btn save-text-note-btn';
                saveBtn.innerHTML = '💾 حفظ التعديل';
                saveBtn.style.display = 'none';
                saveBtn.onclick = () => saveEditedNote(index);
                actionsDiv.appendChild(saveBtn);

                const cancelBtn = document.createElement('button');
                cancelBtn.className = 'control-btn cancel-text-note-btn';
                cancelBtn.innerHTML = 'إلغاء';
                cancelBtn.style.display = 'none';
                cancelBtn.onclick = () => cancelEditNote(index);
                actionsDiv.appendChild(cancelBtn);

                // General jump/delete buttons for text notes
                const jumpButton = document.createElement('button');
                jumpButton.className = 'control-btn'; jumpButton.innerHTML = '🔗';
                jumpButton.title = 'انتقل إلى هذا الوقت'; jumpButton.onclick = () => jumpTo(note.time);
                actionsDiv.appendChild(jumpButton);

                const deleteButton = document.createElement('button');
                deleteButton.className = 'clear-search-btn'; deleteButton.innerHTML = '🗑️';
                deleteButton.title = 'حذف الملاحظة'; deleteButton.onclick = () => deleteNote(index);
                actionsDiv.appendChild(deleteButton);


                noteContent.appendChild(actionsDiv);

            } else if (note.type === 'audio') {
                 let audioDisplayName = note.uploaded && note.filename ? `ملف صوتي: ${note.filename}` : "ملاحظة صوتية مسجلة";
                 noteContent.innerHTML = timePrefixHTML + `${audioDisplayName}: <audio controls src="${note.data || ''}"></audio>`;
                 let audioElementRef = noteContent.querySelector('audio');

                 if (audioElementRef) {
                    const audioNoteIdentifier = note.filename || `audio-note-${index}`;
                    audioElementRef.onloadedmetadata = function() {
                        console.log(`AUDIO EVENT [loadedmetadata]: "${audioNoteIdentifier}", Duration: ${this.duration}, ReadyState: ${this.readyState}, Uploaded: ${!!note.uploaded}`);
                    };
                    audioElementRef.ondurationchange = function() {
                        console.log(`AUDIO EVENT [durationchange]: "${audioNoteIdentifier}", New Duration: ${this.duration}, Uploaded: ${!!note.uploaded}`);
                    };
                    audioElementRef.onerror = function(e) {
                        let errorDetails = "Unknown Error";
                        if (this.error) { errorDetails = `Code: ${this.error.code}, Message: ${this.error.message}`; }
                        console.error(`AUDIO EVENT [error]: "${audioNoteIdentifier}", Details: ${errorDetails}, Uploaded: ${!!note.uploaded}`, e);
                    };
                 }

                 if (note.annotation && note.annotation.trim() !== "") {
                    const annotationDiv = document.createElement('div');
                    annotationDiv.className = 'audio-annotation-text';
                    annotationDiv.textContent = note.annotation;
                    noteContent.appendChild(annotationDiv);
                 }

                const audioNoteButtonsContainer = document.createElement('div');
                audioNoteButtonsContainer.className = 'note-buttons-container';

                const jumpButton = document.createElement('button');
                jumpButton.className = 'control-btn'; jumpButton.innerHTML = '🔗';
                jumpButton.title = 'انتقل إلى هذا الوقت'; jumpButton.onclick = () => jumpTo(note.time);
                audioNoteButtonsContainer.appendChild(jumpButton);

                const deleteButton = document.createElement('button');
                deleteButton.className = 'clear-search-btn'; deleteButton.innerHTML = '🗑️';
                deleteButton.title = 'حذف الملاحظة'; deleteButton.onclick = () => deleteNote(index);
                audioNoteButtonsContainer.appendChild(deleteButton);

                const editAnnotationButton = document.createElement('button');
                editAnnotationButton.className = 'control-btn';
                editAnnotationButton.innerHTML = '✏️';
                editAnnotationButton.title = 'إضافة/تعديل وصف للصوت';
                editAnnotationButton.onclick = () => editAudioAnnotation(index);
                audioNoteButtonsContainer.appendChild(editAnnotationButton);

                const optionsButton = document.createElement('button');
                optionsButton.className = 'control-btn note-options-btn';
                optionsButton.innerHTML = '⋮';
                optionsButton.title = 'خيارات تشغيل الصوت';
                optionsButton.onclick = (event) => {
                    if (audioElementRef) showAudioOptionsMenu(event, index, audioElementRef);
                };
                audioNoteButtonsContainer.appendChild(optionsButton);
                noteContent.appendChild(audioNoteButtonsContainer);
            }

            listItem.appendChild(reorderButtons);
            listItem.appendChild(noteContent);
            notesListElement.appendChild(listItem);
        });
        renderMathInElement(notesListElement);
    }

    function editAudioAnnotation(index) {
        if (index < 0 || index >= notes.length || notes[index].type !== 'audio') return;
        const note = notes[index];
        const currentAnnotation = note.annotation || "";
        const newAnnotation = prompt("أضف أو قم بتعديل الوصف للملاحظة الصوتية:", currentAnnotation);

        if (newAnnotation !== null) {
            notes[index].annotation = newAnnotation.trim();
            updateNotesList();
        }
    }

    function showAudioOptionsMenu(event, noteIndex, audioElement) {
        event.stopPropagation();
        closeAllAudioOptionMenus();

        if (!audioElement) return;

        const menu = document.createElement('div');
        menu.className = 'audio-options-menu';
        const btnRect = event.target.getBoundingClientRect();
        menu.style.top = (btnRect.bottom + window.scrollY) + 'px';
        menu.style.left = (btnRect.left + window.scrollX) + 'px';


        const speeds = [1, 1.5, 2];
        speeds.forEach(speed => {
            const speedBtn = document.createElement('button');
            speedBtn.innerText = `سرعة ${speed}x`;
            speedBtn.onclick = () => {
                audioElement.playbackRate = speed;
                closeAllAudioOptionMenus();
            };
            menu.appendChild(speedBtn);
        });

        const customSpeedControls = document.createElement('div');
        customSpeedControls.className = 'custom-speed-controls';

        const customSpeedInput = document.createElement('input');
        customSpeedInput.type = 'number';
        customSpeedInput.min = '0.5';
        customSpeedInput.max = '50';
        customSpeedInput.step = '0.1';
        customSpeedInput.placeholder = 'x.x';
        customSpeedInput.value = audioElement.playbackRate;

        const customSpeedBtn = document.createElement('button');
        customSpeedBtn.innerText = 'ضبط مخصص';
        customSpeedBtn.onclick = () => {
            const customVal = parseFloat(customSpeedInput.value);
            if (!isNaN(customVal) && customVal >= 0.5 && customVal <= 50) {
                audioElement.playbackRate = customVal;
                closeAllAudioOptionMenus();
            } else {
                alert('الرجاء إدخال سرعة بين 0.5 و 50.');
            }
        };
        customSpeedControls.appendChild(customSpeedInput);
        customSpeedControls.appendChild(customSpeedBtn);
        menu.appendChild(customSpeedControls);

        document.body.appendChild(menu);

        setTimeout(() => {
            document.addEventListener('click', handleClickOutsideMenu, { capture: true, once: true });
        }, 0);
    }

    function handleClickOutsideMenu(event) {
        const openMenu = document.querySelector('.audio-options-menu');
        if (openMenu && !openMenu.contains(event.target)) {
            if (!event.target.classList.contains('note-options-btn')) {
                closeAllAudioOptionMenus();
            }
        }
    }


    function closeAllAudioOptionMenus() {
        document.querySelectorAll('.audio-options-menu').forEach(m => m.remove());
    }


    function moveNoteUp(index) {
        if (index > 0) {
            if (currentlyEditingNoteIndex === index) cancelEditNote(index);
            else if (currentlyEditingNoteIndex === index - 1) cancelEditNote(index - 1);
            [notes[index], notes[index - 1]] = [notes[index - 1], notes[index]];
            updateNotesList();
        }
    }
    function moveNoteDown(index) {
        if (index < notes.length - 1) {
             if (currentlyEditingNoteIndex === index) cancelEditNote(index);
             else if (currentlyEditingNoteIndex === index + 1) cancelEditNote(index + 1);
            [notes[index], notes[index + 1]] = [notes[index + 1], notes[index]];
            updateNotesList();
        }
    }
    function deleteNote(index) { // Updated to handle currentlyEditingNoteIndex adjustments
        if (index < 0 || index >= notes.length) return;

        const noteToDelete = notes[index];
        if (noteToDelete.type === 'text' && currentlyEditingNoteIndex === index) {
            cancelEditNote(index); // This also resets currentlyEditingNoteIndex
        }

        const noteType = noteToDelete.type === 'text' ? 'النصية' : (noteToDelete.filename ? `ملف (${noteToDelete.filename})` : 'الصوتية');
        const noteTime = formatTime(noteToDelete.time);

        if (confirm(`هل أنت متأكد من حذف الملاحظة ${noteType} عند ${noteTime}؟`)) {
            notes.splice(index, 1);
            if (currentlyEditingNoteIndex === index) { // Should have been reset by cancelEditNote if it was a text note
                currentlyEditingNoteIndex = -1;
                originalNoteHTML = '';
            } else if (currentlyEditingNoteIndex > index) {
                currentlyEditingNoteIndex--;
            }
            updateNotesList();
        }
    }

    function jumpTo(time) {
        if (!player || typeof player.seekTo !== 'function') return alert("❌ المشغل غير جاهز للانتقال.");
        try {
            player.seekTo(time, true);
            if (player.getPlayerState() !== YT.PlayerState.PLAYING) player.playVideo();
        } catch (e) { console.error("Error jumping:", e); alert("❌ خطأ في الانتقال."); }
    }
    function formatTime(seconds) {
         seconds = Math.max(0, seconds || 0);
         let min = Math.floor(seconds / 60);
         let sec = Math.floor(seconds % 60);
         let hours = Math.floor(min / 60);
         min = min % 60;
         if (hours > 0) {
              return `${hours}:${min < 10 ? "0" : ""}${min}:${sec < 10 ? "0" : ""}${sec}`;
         } else {
              return `${min}:${sec < 10 ? "0" : ""}${sec}`;
         }
    }


    // --- Image Gallery & Modal ---
    function setupImageHandling() {
        const imageUploadInput = document.getElementById('imageUpload');
        const imageModal = document.getElementById('imageModal');
        if (imageUploadInput) imageUploadInput.addEventListener('change', handleImageUpload);
        if (imageModal) imageModal.addEventListener('click', function(event) { if (event.target === this) closeModal(); });
    }
    function handleImageUpload(event) {
        const files = event.target.files;
        if (!files || files.length === 0) return;
        const imageFiles = Array.from(files).filter(file => file.type.startsWith('image/'));
        if (imageFiles.length === 0 && files.length > 0) {
             alert("❌ يرجى اختيار ملفات صور فقط."); event.target.value = ''; return;
        }
        if (imageFiles.length === 0) return;
        processImageFilesSequentially(imageFiles, () => { if(event.target) event.target.value = ''; });
    }

    async function processImageFilesSequentially(files, callback) {
        const imageFiles = Array.from(files);
        let addedCount = 0;

        for (const file of imageFiles) {
            if (!file.type.startsWith('image/')) continue;

            try {
                const reader = new FileReader();
                const result = await new Promise((resolve, reject) => {
                    reader.onloadend = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });

                if (result && String(result).startsWith('data:image')) {
                    lectureImages.push({ id: Date.now() + '-' + Math.random().toString(16).slice(2), data: result });
                    addedCount++;
                }
            } catch (error) {
                console.error("FileReader img error:", file.name, error);
                alert(`❌ خطأ قراءة الصورة: ${file.name}`);
            }
        }

        if (addedCount > 0) {
            updateImageGallery();
        }
        if (callback) callback();
    }


    function updateImageGallery() {
        const gallery = document.getElementById('imageGallery');
        if(!gallery) return;
        gallery.innerHTML = '';
        lectureImages.forEach((imgData, index) => {
            const container = document.createElement('div'); container.className = 'img-container';
            const imgElement = document.createElement('img'); imgElement.src = imgData.data; imgElement.alt = `صورة ${index + 1}`; imgElement.title = `صورة ${index + 1}`; imgElement.onclick = () => openModal(index); imgElement.onerror = () => { imgElement.alt = "خطأ"; imgElement.style.border = "2px solid red";};
            const deleteBtn = document.createElement('button'); deleteBtn.innerHTML = '×'; deleteBtn.className = 'delete-img-btn'; deleteBtn.title = 'حذف'; deleteBtn.onclick = (e) => { e.stopPropagation(); deleteImage(index); };

            const reorderButtons = document.createElement('div');
            reorderButtons.className = 'image-reorder-buttons';
            const upButton = document.createElement('button');
            upButton.innerHTML = '▲'; upButton.title = 'تحريك لأعلى';
            upButton.onclick = (e) => { e.stopPropagation(); moveImageUp(index); };
            if (index === 0) upButton.disabled = true;
            const downButton = document.createElement('button');
            downButton.innerHTML = '▼'; downButton.title = 'تحريك لأسفل';
            downButton.onclick = (e) => { e.stopPropagation(); moveImageDown(index); };
            if (index === lectureImages.length - 1) downButton.disabled = true;
            reorderButtons.appendChild(upButton); reorderButtons.appendChild(downButton);

            container.appendChild(imgElement);
            container.appendChild(deleteBtn);
            container.appendChild(reorderButtons);
            gallery.appendChild(container);
        });
    }

     function moveImageUp(index) {
        if (index > 0) {
            [lectureImages[index], lectureImages[index - 1]] = [lectureImages[index - 1], lectureImages[index]];
            updateImageGallery();
        }
     }
     function moveImageDown(index) {
        if (index < lectureImages.length - 1) {
            [lectureImages[index], lectureImages[index + 1]] = [lectureImages[index + 1], lectureImages[index]];
            updateImageGallery();
        }
     }
    function deleteImage(index) {
        if (index < 0 || index >= lectureImages.length) return;
        if (confirm(`هل أنت متأكد من حذف هذه الصورة؟`)) { lectureImages.splice(index, 1); updateImageGallery(); }
    }
    function openModal(index) {
        if (index < 0 || index >= lectureImages.length) return;
        currentModalIndex = index; const modal = document.getElementById('imageModal'); const modalImg = document.getElementById('modalImage');
        if (modal && modalImg) {
            modalImg.src = lectureImages[currentModalIndex].data; modal.style.display = 'block';
            document.addEventListener('keydown', handleModalKeydown); document.body.style.overflow = 'hidden';
        }
    }
    function closeModal() {
        const modal = document.getElementById('imageModal');
        if (modal) modal.style.display = 'none';
        document.removeEventListener('keydown', handleModalKeydown); document.body.style.overflow = '';
    }
    function changeModalImage(step) {
        const totalImages = lectureImages.length; if (totalImages === 0) return;
        currentModalIndex = (currentModalIndex + step + totalImages) % totalImages;
        const modalImg = document.getElementById('modalImage');
        if(modalImg && lectureImages[currentModalIndex]) modalImg.src = lectureImages[currentModalIndex].data; else closeModal();
    }
    function handleModalKeydown(event) {
        const imageModalEl = document.getElementById('imageModal');
        if (!imageModalEl || imageModalEl.style.display !== 'block') { document.removeEventListener('keydown', handleModalKeydown); return; }
        switch (event.key) { case 'Escape': closeModal(); break; case 'ArrowLeft': changeModalImage(-1); break; case 'ArrowRight': changeModalImage(1); break; }
    }

    // --- Dark Mode ---
    function toggleDarkMode() {
        document.body.classList.toggle("dark-mode");
        renderMathInElement(document.getElementById('summaryContent'));
        renderMathInElement(document.getElementById('notesList'));
        closeAllAudioOptionMenus();
    }

    // --- Export/Import Data ---
    function exportData() {
        // Ensure any active text edit is cancelled before exporting to get latest data
        if (currentlyEditingNoteIndex !== -1) {
            cancelEditNote(currentlyEditingNoteIndex);
        }
        try {
            const state = {
                notes: notes,
                lectureImages: lectureImages,
                transcript: document.getElementById('transcriptInput')?.value || '',
                summary: document.getElementById('summaryContent')?.innerHTML || '',
                videoUrl: currentVideoUrl,
                currentTime: (player && typeof player.getCurrentTime === 'function') ? player.getCurrentTime() : 0
            };
            const stateString = JSON.stringify(state, null, 2);
            const blob = new Blob([stateString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'lecture_data_export.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            console.log("Data exported successfully.");
        } catch (error) {
            console.error("Error exporting data:", error);
            alert("❌ حدث خطأ أثناء محاولة تصدير البيانات.");
        }
    }
    function importData() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'application/json';
        input.onchange = (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedState = JSON.parse(e.target.result);
                        const transcriptInputEl = document.getElementById('transcriptInput');
                        const summaryContentEl = document.getElementById('summaryContent');
                        const videoUrlInputEl = document.getElementById("videoUrl");

                        notes = importedState.notes || [];
                        notes.forEach(note => {
                            if (note.type === 'audio') {
                                if (typeof note.annotation === 'undefined') note.annotation = "";
                                if (typeof note.uploaded === 'undefined') {
                                    note.uploaded = !!(note.filename && !note.filename.startsWith('تسجيل-'));
                                }
                            }
                            if (note.type === 'text' && typeof note.text === 'undefined') {
                                note.text = "";
                            }
                        });

                        lectureImages = importedState.lectureImages || [];
                        if (transcriptInputEl) transcriptInputEl.value = importedState.transcript || '';
                        if (summaryContentEl) summaryContentEl.innerHTML = importedState.summary || '🔍 لم يتم توليد ملخص بعد.';
                        currentVideoUrl = importedState.videoUrl || '';
                        if (videoUrlInputEl) videoUrlInputEl.value = currentVideoUrl;
                        savedVideoTime = importedState.currentTime || 0;

                        if (currentlyEditingNoteIndex !== -1) {
                            cancelEditNote(currentlyEditingNoteIndex);
                        }

                        updateNotesList();
                        updateImageGallery();
                        renderMathInElement(summaryContentEl);
                        renderMathInElement(document.getElementById('notesList'));

                        if(currentVideoUrl) {
                            setTimeout(() => loadVideo(currentVideoUrl), 100);
                        } else {
                             if (player && typeof player.destroy === 'function') {
                                try { player.destroy(); player = null; } catch (err) { console.error("Error destroying player after import:", err); }
                            }
                             const videoContainerEl = document.getElementById("videoContainer");
                             if(videoContainerEl) videoContainerEl.innerHTML = '<p class="center-text" style="padding: 20px; color: #6c757d;">أدخل رابط فيديو يوتيوب واضغط "تشغيل الفيديو" للبدء.</p>';
                        }
                        alert("✅ تم استيراد البيانات لهذه الجلسة بنجاح.");
                    } catch (error) {
                        console.error("Error importing data:", error);
                        alert("❌ حدث خطأ أثناء محاولة استيراد البيانات. تأكد من أن الملف صحيح.");
                    }
                };
                reader.onerror = (error) => {
                    console.error("Error reading file:", error);
                    alert("❌ حدث خطأ أثناء قراءة الملف.");
                };
                reader.readAsText(file);
            }
        };
        input.click();
    }

    // --- Toggle Floating Note Button ---
    function toggleFloatingNoteButton() {
        const button = document.getElementById('floatingNoteButton');
        if (button) {
            if (button.style.display === 'none' || button.style.display === '') {
                button.style.display = 'block';
            } else {
                button.style.display = 'none';
            }
        }
    }
    function toggleNotesSection() {
        const notesSection = document.querySelector('.notes-section');
        if (notesSection) {
            notesSection.scrollIntoView({ behavior: 'smooth' });
        }
    }

    // --- Download Page ---
     function downloadPage() {
        try {
            console.log("Preparing page HTML for saving...");
            if (currentlyEditingNoteIndex !== -1) {
                alert("يرجى حفظ أو إلغاء تعديل الملاحظة النصية الحالية قبل حفظ الصفحة.");
                return;
            }
            const clonedDoc = document.documentElement.cloneNode(true);
            const videoUrlInputEl = document.getElementById('videoUrl');
            const transcriptInputEl = document.getElementById('transcriptInput');
            // No longer using noteText textarea for main input
            const noteEditor = document.getElementById('noteTextEditable');
            const summaryContentEl = document.getElementById('summaryContent');

            const clonedVideoUrlInput = clonedDoc.querySelector('#videoUrl');
            if(clonedVideoUrlInput && videoUrlInputEl) clonedVideoUrlInput.value = videoUrlInputEl.value;

            const clonedTranscript = clonedDoc.querySelector('#transcriptInput');
            if (clonedTranscript && transcriptInputEl) clonedTranscript.textContent = transcriptInputEl.value;

            // Save current content of main note editor if needed (though it's usually cleared on save)
            const clonedNoteEditor = clonedDoc.querySelector('#noteTextEditable');
            if(clonedNoteEditor && noteEditor) clonedNoteEditor.innerHTML = noteEditor.innerHTML;


            const clonedSummaryContent = clonedDoc.querySelector('#summaryContent');
            if(clonedSummaryContent && summaryContentEl) clonedSummaryContent.innerHTML = summaryContentEl.innerHTML;

             const clonedNotesList = clonedDoc.querySelector('#notesList');
             if(clonedNotesList) {
                  clonedNotesList.innerHTML = '';
                  notes.forEach((note) => {
                    let listItem = document.createElement("li");
                    listItem.style.cssText = "background-color:#fff;padding:15px;margin-bottom:10px;border-radius:5px;box-shadow:0px 1px 3px rgba(0,0,0,0.1);text-align:right;font-size:15px;line-height:1.6;";

                    let contentHTML = `<b style="font-weight:bold;color:#007bff;margin-left:5px;">[${formatTime(note.time)}]</b> `;
                    if (note.type === 'text') {
                         contentHTML += `ملاحظة نصية:<div class="text-note-content-editable" style="background-color:#f8f9fa;border:1px solid #e9ecef;padding:10px;margin-top:8px;border-radius:4px;white-space:pre-wrap;word-wrap:break-word;width:100%;box-sizing:border-box;">${note.text}</div>`;
                    } else if (note.type === 'audio') {
                       let audioDisplayName = note.uploaded && note.filename ? `ملف صوتي: ${note.filename.replace(/&/g, '&').replace(/</g, "<").replace(/>/g, ">")}` : "ملاحظة صوتية مسجلة";
                       contentHTML += `${audioDisplayName}: <audio controls src="${note.data || ''}" style="width:100%;max-width:300px;margin-top:10px;"></audio>`;
                       if (note.annotation && note.annotation.trim() !== "") {
                           contentHTML += `<div class="audio-annotation-text" style="font-size:0.9em;color:#555;margin-top:8px;padding:8px;border-radius:4px;background-color:#f0f0f0;border:1px solid #e0e0e0;width:calc(100% - 16px);box-sizing:border-box;white-space:pre-wrap;word-wrap:break-word;">${note.annotation.replace(/&/g, '&').replace(/</g, "<").replace(/>/g, ">")}</div>`;
                       }
                    }
                    listItem.innerHTML = contentHTML;
                    clonedNotesList.appendChild(listItem);
                  });
             }

            const clonedImageGallery = clonedDoc.querySelector('#imageGallery');
            if(clonedImageGallery) {
                clonedImageGallery.innerHTML = '';
                lectureImages.forEach((imgData) => {
                    const imgElement = document.createElement('img');
                    imgElement.src = imgData.data;
                    imgElement.alt = `صورة`;
                    imgElement.style.cssText = 'display: inline-block; width: 120px; height: 120px; object-fit: cover; margin: 5px; border: 1px solid #ccc;';
                    clonedImageGallery.appendChild(imgElement);
                });
            }

             const savedTimeElement = clonedDoc.createElement('div');
             savedTimeElement.id = 'savedVideoPlaybackTime';
             let currentTimeForSave = 0;
             if (player && typeof player.getCurrentTime === 'function') {
                try { currentTimeForSave = player.getCurrentTime(); } catch(e) { /* ignore */ }
             }
             savedTimeElement.setAttribute('data-time', currentTimeForSave);
             savedTimeElement.style.display = 'none';
             clonedDoc.body.appendChild(savedTimeElement);

            const selectorsToRemove = [
                '.floating-controls', '.floating-right-controls',
                '#recordNoteBtn', '#audioUploadInput', 'label[for="audioUploadInput"]', '#recordingStatus',
                '#imageUpload', 'label[for="imageUpload"]',
                '#downloadPageBtn', '#exportBtn', '#importBtn', '#toggleFloatingNoteBtn', '#resetPageBtn',
                '#mainHighlightPalette', // Remove the main highlight palette
                '#notesList .reorder-buttons', '#notesList .note-buttons-container', '#notesList .text-note-actions',
                '#imageGallery .delete-img-btn', '.image-reorder-buttons',
                '#imageModal',
                'script[src*="iframe_api"]',
                'script[src*="polyfill.min.js"]',
                '#playerStatus',
                '.search-box button', '.search-box input#searchText',
                '.speed-controls',
                'script:last-of-type'
            ];
             selectorsToRemove.forEach(selector => { clonedDoc.querySelectorAll(selector).forEach(el => el.remove()); });


             const head = clonedDoc.querySelector('head');
             if(head) {
                  const meta = document.createElement('meta'); meta.name = "description";
                  meta.content = "نسخة محفوظة من صفحة الملاحظات. تحتوي على ملاحظات وصور مضمنة."; head.appendChild(meta);
             }

             const clonedVideoContainer = clonedDoc.querySelector('#videoContainer');
             if(clonedVideoContainer && videoUrlInputEl && videoUrlInputEl.value) {
                 clonedVideoContainer.innerHTML = `<p class="center-text" style="padding: 20px; color: #6c757d;">رابط الفيديو الأصلي: <a href="${videoUrlInputEl.value}" target="_blank">${videoUrlInputEl.value}</a></p>`;
                 const savedTimeAttr = savedTimeElement.getAttribute('data-time');
                 if (savedTimeAttr && parseFloat(savedTimeAttr) > 0) {
                      const timeP = clonedDoc.createElement('p');
                      timeP.className = 'center-text';
                      timeP.style.color = '#6c757d';
                      timeP.innerText = `تم حفظ الفيديو عند الوقت: ${formatTime(parseFloat(savedTimeAttr))}`;
                      clonedVideoContainer.appendChild(timeP);
                 }
             } else if (clonedVideoContainer) {
                 clonedVideoContainer.innerHTML = '<p class="center-text" style="padding: 20px; color: #6c757d;">لم يتم تحميل فيديو في هذه الجلسة.</p>';
             }

            const essentialScript = clonedDoc.createElement('script');
            essentialScript.textContent = `
                document.addEventListener('DOMContentLoaded', () => {
                    if (typeof MathJax !== 'undefined' && MathJax.typesetPromise) {
                        MathJax.typesetPromise([document.body]).catch(err => console.error('MathJax error on saved page:', err));
                    } else if (typeof MathJax !== 'undefined' && MathJax.typeset) {
                        MathJax.typeset(document.body);
                    }
                    const timeEl = document.getElementById('savedVideoPlaybackTime');
                    if(timeEl) timeEl.remove();
                });
            `;
            clonedDoc.body.appendChild(essentialScript);

            const finalHtml = "<!DOCTYPE html>\n" + clonedDoc.outerHTML;
            const blob = new Blob([finalHtml], { type: 'text/html;charset=UTF-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url;
            let filename = "lecture_page_saved.html";
            try {
                 const videoTitle = (player && typeof player.getVideoData === 'function' && player.getVideoData().title) ? player.getVideoData().title : '';
                 if (videoTitle) filename = videoTitle.replace(/[^a-z0-9\u0600-\u06FF\s_.-]/gi, '_').replace(/\s+/g, '_').substring(0, 50) + "_saved.html";
                 else if (currentVideoUrl) filename = 'video_notes_' + extractVideoID(currentVideoUrl) + '_saved.html';
            } catch (e) { console.error("Error generating filename:", e); }
            a.download = filename; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
            console.log("Page HTML saved as:", filename);
        } catch (error) {
            console.error("Error saving page HTML:", error);
            alert("❌ حدث خطأ أثناء محاولة حفظ الصفحة كـ HTML.");
        }
    }


    // --- Reset Page Function ---
    function resetPage() {
        if (confirm("هل أنت متأكد أنك تريد إعادة تعيين الصفحة؟ سيؤدي هذا إلى مسح جميع الملاحظات والصور والبيانات لهذه الجلسة.")) {
            if (currentlyEditingNoteIndex !== -1) {
                const listItem = document.querySelector(`#notesList li[data-note-index="${currentlyEditingNoteIndex}"]`);
                if (listItem) {
                    cancelEditNote(currentlyEditingNoteIndex);
                }
                currentlyEditingNoteIndex = -1;
                originalNoteHTML = '';
            }

            resetAppState(true);
            notes = [];
            lectureImages = [];
            currentVideoUrl = '';
            savedVideoTime = 0;
            captionsData = [];
            currentHighlights = [];

            document.getElementById("videoUrl").value = "";
            document.getElementById("noteTextEditable").innerHTML = ""; // Clear new editor
            document.getElementById("transcriptInput").value = "";
            document.getElementById("summaryContent").innerHTML = "🔍 لم يتم توليد ملخص بعد.";
            document.getElementById("searchResults").innerHTML = "";

            updateNotesList();
            updateImageGallery();

            if (player && typeof player.destroy === 'function') {
                try { player.destroy(); player = null; } catch (e) { console.error("Error destroying player on reset:", e); }
            }
            if(document.getElementById("videoContainer")) document.getElementById("videoContainer").innerHTML = '<p class="center-text" style="padding: 20px; color: #6c757d;">أدخل رابط فيديو يوتيوب واضغط "تشغيل الفيديو" للبدء.</p>';

            console.log("Page state reset for the current session.");
            alert("✅ تم إعادة تعيين الصفحة لهذه الجلسة بنجاح.");
        }
    }

    function resetAppState(clearAll = false) {
        const transcriptInputEl = document.getElementById("transcriptInput");
        const summaryContentEl = document.getElementById("summaryContent");
        const searchResultsEl = document.getElementById("searchResults");
        const searchTextEl = document.getElementById("searchText");
        const clearSearchBtnEl = document.getElementById("clearSearchBtn");

        if(transcriptInputEl) transcriptInputEl.value = "";
        if(summaryContentEl) summaryContentEl.innerHTML = "🔍 لم يتم توليد ملخص بعد.";
        if(searchResultsEl) searchResultsEl.innerHTML = "";
        if(searchTextEl) searchTextEl.value = "";
        if(clearSearchBtnEl) clearSearchBtnEl.style.display = 'none';

        isPlaying = false; updatePlayPauseButton();
        closeAllAudioOptionMenus();
        console.log(`App visual state reset.`);
    }

    window.addEventListener('beforeunload', function (e) {
      if (notes.length > 0 || lectureImages.length > 0 ||
          (document.getElementById('transcriptInput')?.value.trim() !== '') ||
          (document.getElementById('summaryContent')?.innerHTML && !document.getElementById('summaryContent').innerHTML.includes('لم يتم توليد ملخص بعد'))) {
        const confirmationMessage = 'هل أنت متأكد أنك تريد مغادرة هذه الصفحة؟ سيتم فقدان جميع البيانات غير المصدرة.';
        e.preventDefault();
        e.returnValue = confirmationMessage;
        return confirmationMessage;
      }
    });


    document.addEventListener('DOMContentLoaded', () => {
        console.log("DOM ready.");
        loadYouTubeAPI();
        setupImageHandling();
        setupAudioUpload();
        updatePlayPauseButton();
        updateNotesList();
        updateImageGallery();

        const savedTimeElement = document.getElementById('savedVideoPlaybackTime');
        if (savedTimeElement) {
             const time = parseFloat(savedTimeElement.getAttribute('data-time'));
             if (!isNaN(time) && time > 0) {
                  savedVideoTime = time;
                  console.log(`Detected saved video time from HTML structure (if any): ${formatTime(savedVideoTime)}`);
             }
        }
    });

  </script>
</body>
</html>